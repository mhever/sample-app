name: Bump Kustomize image tag

on:
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types:
      - completed

permissions:
  contents: write

jobs:
  bump-tag:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: main

      - name: Compute image tag (7-char SHA)
        id: vars
        run: |
          SHORT_SHA=$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)
          echo "short_sha=$SHORT_SHA" >> "$GITHUB_OUTPUT"

      - name: Update kustomization.yaml image tag
        run: |
          FILE="k8s/overlays/home/kustomization.yaml"
          TAG="sha-${{ steps.vars.outputs.short_sha }}"
          echo "Setting image tag to $TAG in $FILE"
          # Replace the newTag line (assumes a line starting with 'newTag:')
          sed -i "s/^\\(\\s*newTag:\\s*\\).*/\\1${TAG}/" "$FILE"
          echo "Result:"
          grep -n "newTag:" "$FILE"

      - name: Commit and push (skip CI)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add k8s/overlays/home/kustomization.yaml
          git commit -m "chore(gitops): deploy sha-${{ steps.vars.outputs.short_sha }} [skip ci]" || exit 0
          git push
